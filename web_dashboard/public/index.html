<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modbus TCP Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
    }
    h1 { text-align: center; margin-bottom: 4px; font-size: 1.4rem; color: #00d4ff; }
    .subtitle { text-align: center; font-size: 0.82rem; color: #888; margin-bottom: 16px; }

    /* ---- Summary cards ---- */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      max-width: 1000px;
      margin: 0 auto 18px;
    }
    .card {
      background: #16213e;
      border-radius: 8px;
      padding: 14px 16px;
      border-left: 4px solid #00d4ff;
    }
    .card.warn  { border-left-color: #ffaa00; }
    .card.error { border-left-color: #f44; }
    .card-label { font-size: 0.72rem; text-transform: uppercase; color: #888; margin-bottom: 4px; letter-spacing: 0.5px; }
    .card-value { font-size: 1.3rem; font-weight: 700; color: #fff; }
    .card-sub   { font-size: 0.72rem; color: #666; margin-top: 3px; }

    /* ---- Device table ---- */
    table {
      width: 100%;
      max-width: 1060px;
      margin: 0 auto 24px;
      border-collapse: collapse;
    }
    th, td { padding: 7px 10px; text-align: center; border: 1px solid #333; }
    th { background: #16213e; color: #00d4ff; font-weight: 600; font-size: 0.78rem; text-transform: uppercase; }
    td { font-size: 0.88rem; }
    tr:nth-child(even) { background: rgba(255,255,255,0.03); }
    tr:hover { background: rgba(0,212,255,0.08); }

    /* Tooltip cells */
    td[title] { cursor: help; text-decoration-style: dotted; }

    .comm-ok    { color: #0f6; font-weight: 700; }
    .comm-stale { color: #ffaa00; font-weight: 700; }
    .comm-down  { color: #f44; font-weight: 700; }
    .na { color: #555; }
    .mismatch-ok   { color: #0f6; }
    .mismatch-warn { color: #ffaa00; font-weight: 600; }
    .mismatch-bad  { color: #f44; font-weight: 700; }

    /* ---- Control panel ---- */
    .control {
      max-width: 520px;
      margin: 0 auto;
      background: #16213e;
      border-radius: 8px;
      padding: 18px 24px;
    }
    .control h2 { font-size: 1rem; margin-bottom: 4px; color: #00d4ff; }
    .convention { font-size: 0.75rem; color: #aaa; margin-bottom: 12px; }
    .convention b { color: #0f6; }
    .convention .dis { color: #ff6b35; }
    .control-row { display: flex; gap: 8px; align-items: center; }
    .control-row input {
      flex: 1; padding: 8px 12px;
      border: 1px solid #444; border-radius: 4px;
      background: #0f3460; color: #eee; font-size: 0.95rem;
    }
    .control-row input:focus { outline: none; border-color: #00d4ff; }
    .control-row input:invalid { border-color: #f44; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 0.85rem; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-send { background: #00d4ff; color: #1a1a2e; }
    .btn-send:hover:not(:disabled) { background: #00b8d9; }
    .btn-stop { background: #f44; color: #fff; }
    .btn-stop:hover:not(:disabled) { background: #d32f2f; }

    .range-hint { font-size: 0.72rem; color: #666; margin-top: 4px; }

    /* Presets */
    .presets { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
    .presets button {
      padding: 4px 10px; border: 1px solid #444; border-radius: 4px;
      background: transparent; font-size: 0.75rem; cursor: pointer;
    }
    .presets button:hover { border-color: #00d4ff; }
    .preset-charge { color: #0f6; border-color: #0a5; }
    .preset-charge:hover { border-color: #0f6 !important; }
    .preset-discharge { color: #ff6b35; border-color: #b34a20; }
    .preset-discharge:hover { border-color: #ff6b35 !important; }
    .preset-zero { color: #aaa; }

    .result { margin-top: 10px; font-size: 0.8rem; min-height: 18px; }
    .result.ok  { color: #0f6; }
    .result.err { color: #f44; }
  </style>
</head>
<body>

  <h1>Modbus TCP Dashboard</h1>
  <p class="subtitle">Auto-polling every 1s</p>

  <!-- Summary cards -->
  <div class="cards" id="cards">
    <div class="card" id="cardConn">
      <div class="card-label">Connection</div>
      <div class="card-value" id="cardConnVal">--</div>
      <div class="card-sub" id="cardConnSub">--</div>
    </div>
    <div class="card" id="cardPower">
      <div class="card-label">Total Active Power</div>
      <div class="card-value" id="cardPowerVal">-- kW</div>
      <div class="card-sub" id="cardPowerSub">PMS aggregate</div>
    </div>
    <div class="card" id="cardSOC">
      <div class="card-label">SOC Average</div>
      <div class="card-value" id="cardSOCVal">-- %</div>
      <div class="card-sub" id="cardSOCSub">BMS average</div>
    </div>
    <div class="card" id="cardCmd">
      <div class="card-label">Last Command</div>
      <div class="card-value" id="cardCmdVal">--</div>
      <div class="card-sub" id="cardCmdSub">No command sent yet</div>
    </div>
    <div class="card" id="cardMM">
      <div class="card-label">Multimeter (RTU)</div>
      <div class="card-value" id="cardMMVal">-- kW</div>
      <div class="card-sub" id="cardMMSub">Point of connection</div>
    </div>
  </div>

  <!-- Device table -->
  <table>
    <thead>
      <tr>
        <th>Device</th>
        <th>Unit ID</th>
        <th>Demand (kW)</th>
        <th>Active Power (kW)</th>
        <th>ΔP (kW)</th>
        <th>SOC (%)</th>
        <th>SOH (%)</th>
        <th>Capacity (kWh)</th>
        <th>Comm</th>
      </tr>
    </thead>
    <tbody id="deviceTable">
      <tr><td colspan="9" class="na">Waiting for first poll...</td></tr>
    </tbody>
  </table>

  <!-- Control panel -->
  <div class="control">
    <h2>Set PMS demand_control_power</h2>
    <div class="convention">
      Sign convention: <b>-kW = Charge</b> (SOC rises) &nbsp;|&nbsp; <span class="dis">+kW = Discharge</span> (SOC falls)
    </div>
    <div class="control-row">
      <input type="number" id="demandInput" step="0.1" min="-3276.8" max="3276.7" placeholder="kW (-3276.8 to 3276.7)" />
      <button class="btn btn-send" id="sendBtn" onclick="sendDemand()">Send (FC06)</button>
      <button class="btn btn-stop" id="stopBtn" onclick="sendStop()">STOP (0)</button>
    </div>
    <div class="range-hint">Range: -3276.8 .. 3276.7 kW | Step: 0.1 kW</div>
    <div class="presets">
      <button class="preset-charge" onclick="setPreset(-3276.8)">-3276.8 (Max Charge)</button>
      <button class="preset-charge" onclick="setPreset(-1000)">-1000</button>
      <button class="preset-charge" onclick="setPreset(-500)">-500</button>
      <button class="preset-charge" onclick="setPreset(-100)">-100</button>
      <button class="preset-charge" onclick="setPreset(-50)">-50</button>
      <button class="preset-zero" onclick="setPreset(0)">0 (Stop)</button>
      <button class="preset-discharge" onclick="setPreset(50)">+50</button>
      <button class="preset-discharge" onclick="setPreset(100)">+100</button>
      <button class="preset-discharge" onclick="setPreset(500)">+500</button>
      <button class="preset-discharge" onclick="setPreset(1000)">+1000</button>
      <button class="preset-discharge" onclick="setPreset(3276.7)">+3276.7 (Max Discharge)</button>
    </div>
    <div class="result" id="cmdResult"></div>
  </div>

  <script>
    let pollCount = 0;
    let currentDemandKw = null; // track to disable Send when unchanged

    // ---- Comm status logic ----
    function getCommStatus(comm) {
      if (!comm) return { cls: "comm-down", text: "NO DATA", tip: "" };
      if (!comm.ok) return { cls: "comm-down", text: "DOWN", tip: comm.last_error || "" };
      if (!comm.last_ok_ts) return { cls: "comm-down", text: "DOWN", tip: "never connected" };
      const ageSec = (Date.now() - new Date(comm.last_ok_ts).getTime()) / 1000;
      if (ageSec > 10) return { cls: "comm-down",  text: "DOWN",  tip: `Last OK ${ageSec.toFixed(0)}s ago` };
      if (ageSec > 3)  return { cls: "comm-stale", text: "STALE", tip: `Last OK ${ageSec.toFixed(0)}s ago` };
      return { cls: "comm-ok", text: "OK", tip: `${ageSec.toFixed(1)}s ago` };
    }

    // ---- Tooltip builder ----
    function tip(raw, meta) {
      if (raw === null || raw === undefined || !meta) return "";
      return `${meta.reg} raw=${raw} scale=${meta.scale} (${meta.fc})`;
    }

    // ---- ΔP mismatch ----
    function deltaPHtml(demand, actual) {
      if (demand === null || actual === null || demand === undefined || actual === undefined) return '<span class="na">\u2014</span>';
      const dp = parseFloat((actual - demand).toFixed(1));
      const abs = Math.abs(dp);
      let cls = "mismatch-ok";
      if (abs > 3.0)      cls = "mismatch-bad";
      else if (abs > 1.0) cls = "mismatch-warn";
      const sign = dp >= 0 ? "+" : "";
      return `<span class="${cls}">${sign}${dp}</span>`;
    }

    // ---- Polling ----
    async function fetchSnapshot() {
      try {
        const resp = await fetch("/api/snapshot");
        const snap = await resp.json();
        pollCount++;
        renderSnapshot(snap);
      } catch (err) {
        document.getElementById("cardConnVal").textContent = "FETCH ERR";
      }
    }

    function renderSnapshot(snap) {
      // ---- Summary cards ----
      const d = snap.devices;
      const pms = d.pms;

      // Connection card
      // External dashboard: PMS only (PCS/BMS are on separate ports, internal only)
      const allComms = [d.pms].map(x => x && x.comm);
      const allOk = allComms.every(c => c && c.ok);
      const anyDown = allComms.some(c => !c || !c.ok);
      const cfg = snap.config || {};
      const connCard = document.getElementById("cardConn");
      if (allOk) {
        document.getElementById("cardConnVal").textContent = "ALL OK";
        connCard.className = "card";
      } else {
        const downCount = allComms.filter(c => !c || !c.ok).length;
        document.getElementById("cardConnVal").textContent = `${downCount} DOWN`;
        connCard.className = "card error";
      }
      document.getElementById("cardConnSub").textContent = `${cfg.host || "?"}:${cfg.port || "?"} | Poll #${pollCount}`;

      // Power card
      const totalPower = pms ? pms.total_active_power_kw : null;
      document.getElementById("cardPowerVal").textContent = totalPower !== null ? `${totalPower} kW` : "-- kW";
      if (pms && pms.demand_control_power_kw !== null) {
        const tp = totalPower || 0;
        const dm = pms.demand_control_power_kw;
        const dpK = parseFloat((tp - dm).toFixed(1));
        document.getElementById("cardPowerSub").textContent = `Demand: ${dm} kW | ΔP: ${dpK >= 0 ? "+" : ""}${dpK} kW`;
      }

      // SOC card
      const socAvg = pms ? pms.soc_avg_pct : null;
      document.getElementById("cardSOCVal").textContent = socAvg !== null ? `${socAvg} %` : "-- %";
      const socCard = document.getElementById("cardSOC");
      if (socAvg !== null && socAvg <= 10) socCard.className = "card error";
      else if (socAvg !== null && socAvg <= 20) socCard.className = "card warn";
      else socCard.className = "card";

      // Last command card
      const lc = snap.last_command;
      if (lc && lc.kw !== null) {
        const lcLabel = lc.kw > 0 ? "Discharge" : lc.kw < 0 ? "Charge" : "Stop";
        document.getElementById("cardCmdVal").textContent = `${lc.kw} kW (${lcLabel})`;
        const lcTime = lc.ts ? new Date(lc.ts).toLocaleTimeString() : "";
        document.getElementById("cardCmdSub").textContent = lc.error ? `ERR: ${lc.error}` : `raw=${lc.raw} @ ${lcTime}`;
        document.getElementById("cardCmd").className = lc.error ? "card error" : "card";
      }

      // Track current demand for Send button disable logic
      currentDemandKw = pms ? pms.demand_control_power_kw : null;
      updateSendBtnState();

      // Multimeter card
      const mm = d.multimeter;
      if (mm && mm.active_power_kw !== null) {
        document.getElementById("cardMMVal").textContent = `${mm.active_power_kw} kW`;
        const mmComm = getCommStatus(mm.comm);
        document.getElementById("cardMMSub").textContent = `RTU slave=${mm.unit_id || 10} | ${mmComm.text}`;
        document.getElementById("cardMM").className = mmComm.cls === "comm-ok" ? "card" : "card warn";
      } else {
        document.getElementById("cardMMVal").textContent = "-- kW";
        document.getElementById("cardMMSub").textContent = mm ? "No data" : "Bridge not running";
        document.getElementById("cardMM").className = "card warn";
      }

      // ---- Device table ----
      // PMS row only — PCS/BMS not accessible from external dashboard
      const rows = [
        deviceRow("PMS", d.pms, {
          demand: true,
          power: "total_active_power_kw", powerRaw: "total_active_power_raw", powerMeta: "total_active_power_meta",
          demandRaw: "demand_control_power_raw", demandMeta: "demand_control_power_meta",
          soc: "soc_avg_pct", socRaw: "soc_avg_raw", socMeta: "soc_avg_meta",
          soh: "soh_avg_pct", sohRaw: "soh_avg_raw", sohMeta: "soh_avg_meta",
          cap: "capacity_total_kwh", capRaw: "capacity_total_raw", capMeta: "capacity_total_meta",
          showDelta: true,
        }),
        mmRow(d.multimeter),
      ];
      document.getElementById("deviceTable").innerHTML = rows.join("");
    }

    function deviceRow(label, dev, f) {
      if (!dev) return `<tr><td>${label}</td><td colspan="8" class="na">No data</td></tr>`;

      const cs = getCommStatus(dev.comm);

      const demand = f.demand
        ? `<td title="${tip(dev[f.demandRaw], dev[f.demandMeta])}">${fmtVal(dev.demand_control_power_kw)}</td>`
        : '<td class="na">\u2014</td>';
      const power = f.power
        ? `<td title="${tip(dev[f.powerRaw], dev[f.powerMeta])}">${fmtVal(dev[f.power])}</td>`
        : '<td class="na">\u2014</td>';
      const delta = f.showDelta
        ? `<td>${deltaPHtml(dev.demand_control_power_kw, dev.total_active_power_kw)}</td>`
        : '<td class="na">\u2014</td>';
      const soc = f.soc
        ? `<td title="${tip(dev[f.socRaw], dev[f.socMeta])}">${fmtVal(dev[f.soc])}</td>`
        : '<td class="na">\u2014</td>';
      const soh = f.soh
        ? `<td title="${tip(dev[f.sohRaw], dev[f.sohMeta])}">${fmtVal(dev[f.soh])}</td>`
        : '<td class="na">\u2014</td>';
      const cap = f.cap
        ? `<td title="${tip(dev[f.capRaw], dev[f.capMeta])}">${fmtVal(dev[f.cap])}</td>`
        : '<td class="na">\u2014</td>';

      return `<tr>
        <td><b>${label}</b></td>
        <td>${dev.unit_id}</td>
        ${demand}${power}${delta}${soc}${soh}${cap}
        <td class="${cs.cls}" title="${cs.tip}">${cs.text}</td>
      </tr>`;
    }

    function mmRow(dev) {
      if (!dev) return `<tr><td><b>Multimeter</b></td><td colspan="8" class="na">Bridge not running</td></tr>`;
      const cs = getCommStatus(dev.comm);
      return `<tr>
        <td><b>Multimeter (RTU)</b></td>
        <td>${dev.unit_id || 10}</td>
        <td class="na">\u2014</td>
        <td title="${tip(dev.active_power_raw, dev.active_power_meta)}">${fmtVal(dev.active_power_kw)}</td>
        <td class="na">\u2014</td>
        <td class="na">\u2014</td>
        <td class="na">\u2014</td>
        <td class="na">\u2014</td>
        <td class="${cs.cls}" title="${cs.tip}">${cs.text}</td>
      </tr>`;
    }

    function fmtVal(v) {
      if (v === null || v === undefined) return '<span class="na">\u2014</span>';
      return v;
    }

    // ---- Send demand ----
    async function sendDemand() {
      const input = document.getElementById("demandInput");
      const result = document.getElementById("cmdResult");
      const kw = parseFloat(input.value);
      if (isNaN(kw)) { result.className = "result err"; result.textContent = "Enter a valid number."; return; }
      if (kw < -3276.8 || kw > 3276.7) { result.className = "result err"; result.textContent = "Range: -3276.8 to 3276.7 kW."; return; }
      await doSend(kw);
    }

    async function sendStop() { await doSend(0); }

    async function doSend(kw) {
      const btn = document.getElementById("sendBtn");
      const stopBtn = document.getElementById("stopBtn");
      const result = document.getElementById("cmdResult");
      btn.disabled = true; stopBtn.disabled = true;
      result.className = "result"; result.textContent = "Sending...";
      try {
        const resp = await fetch("/api/pms/demand", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ demand_control_power_kw: kw }),
        });
        const data = await resp.json();
        if (data.ok) {
          const label = kw > 0 ? "Discharge" : kw < 0 ? "Charge" : "Stop";
          result.className = "result ok";
          result.textContent = `OK \u2014 ${label} ${data.written_kw} kW (raw=${data.written_raw}) @ ${new Date().toLocaleTimeString()}`;
          document.getElementById("demandInput").value = kw;
        } else {
          result.className = "result err";
          result.textContent = `Error: ${data.error}`;
        }
      } catch (err) {
        result.className = "result err";
        result.textContent = `Network error: ${err.message}`;
      } finally {
        btn.disabled = false; stopBtn.disabled = false;
        updateSendBtnState();
      }
    }

    function setPreset(kw) {
      document.getElementById("demandInput").value = kw;
      updateSendBtnState();
    }

    function updateSendBtnState() {
      const input = document.getElementById("demandInput");
      const btn = document.getElementById("sendBtn");
      const kw = parseFloat(input.value);
      // Disable if: NaN, out of range, or same as current demand (to 1 decimal)
      if (isNaN(kw) || kw < -3276.8 || kw > 3276.7) { btn.disabled = true; return; }
      if (currentDemandKw !== null && parseFloat(kw.toFixed(1)) === parseFloat(currentDemandKw.toFixed ? currentDemandKw.toFixed(1) : currentDemandKw)) {
        btn.disabled = true;
      } else {
        btn.disabled = false;
      }
    }

    // Events
    document.getElementById("demandInput").addEventListener("input", updateSendBtnState);
    document.getElementById("demandInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendDemand();
    });

    // Start polling
    fetchSnapshot();
    setInterval(fetchSnapshot, 1000);
  </script>
</body>
</html>
